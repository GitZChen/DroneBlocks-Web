<!DOCTYPE html>
<html manifest="droneblocks.appcache">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width; initial-scale=1.25; maximum-scale=1.25; user-scalable=0;" />
  <title>DroneBlocks POC</title>
  <script src="./blockly/blockly_compressed.js"></script>
  <script src="./blockly/blocks_compressed.js"></script>
  <script src="./blockly/javascript_compressed.js"></script>
  <script src="./blockly/storage.js"></script>
  <script src="./blockly/generators/javascript/droneblocks.js"></script>
  <script src="./blockly/msg/js/en.js"></script>
  <script src="./blockly/blocks/droneblocks/takeoff.js"></script>
  <script src="./blockly/blocks/droneblocks/land.js"></script>
  <script src="./blockly/blocks/droneblocks/land_home.js"></script>
  <script src="./blockly/blocks/droneblocks/hover.js"></script>
  <script src="./blockly/blocks/droneblocks/yaw_right.js"></script>
  <script src="./blockly/blocks/droneblocks/yaw_left.js"></script>
  <script src="./blockly/blocks/droneblocks/photo.js"></script>
  <script src="./blockly/blocks/droneblocks/photo_interval.js"></script>
  <script src="./blockly/blocks/droneblocks/pitch_gimbal.js"></script>
  <script src="./blockly/blocks/droneblocks/fly_forward.js"></script>
  <script src="./blockly/blocks/droneblocks/change_altitude.js"></script>
  <script src="./blockly/blocks/droneblocks/video.js"></script>
  <script src="./blockly/blocks/droneblocks/orbit.js"></script>
  <script src="./blockly/blocks/droneblocks/loop.js"></script>
  <script src="./blockly/blocks/droneblocks/follow.js"></script>
  <style>
    html, body {
      height: 100%;
      margin: 0;
    }
    body {
      background-color: #fff;
      font-family: sans-serif;
      overflow: hidden;
    }
    h1 {
      font-weight: normal;
      font-size: 140%;
    }
    table {
      height: 100%;
      width: 100%;
    }
    #blocklyArea {
      height: 99%;
    }
  </style>
  <link rel="stylesheet" type="text/css" href="droneblocks.css">
</head>
<body>
  <table>
    <tr>
      <td id="blocklyArea">
      </td>
    </tr>
    <!--<tr><td><textarea style="width: 300px; height: 50px;" id="textarea"></textarea></td></tr>-->
    <tr><td style="text-align:right"><a href="#" onclick="uploadMission();">Start Mission</a></td></tr>
  </table>

  <div id="blocklyDiv" style="position: absolute"></div>

  <xml id="toolbox" style="display: none">
    <category name="Takeoff">
      <block type="takeoff">
        <value name="altitude">
          <block type="math_number">
            <field name="NUM">25</field>
          </block>
        </value>
      </block>
    </category>
    <category name="Navigation">
      <block type="fly_forward">
        <value name="distance">
          <block type="math_number">
            <field name="NUM">25</field>
          </block>
        </value>
      </block>
      <block type="change_altitude">
        <value name="altitude">
          <block type="math_number">
            <field name="NUM">25</field>
          </block>
        </value>
      </block>
      <block type="hover"></block>
      <block type="yaw_right"></block>
      <block type="yaw_left"></block>
    </category>
    <category name="Loops">
      <block type="loop">
        <value name="TIMES">
          <block type="math_number">
            <field name="NUM">3</field>
          </block>
        </value>
      </block>
    </category>
    <category name="Camera">
      <block type="pitch_gimbal_to"></block>
      <block type="photo"></block>
      <!--<block type="photo_interval"></block>-->
      <block type="video"></block>
    </category>
    <!--<category name="Flight Modes">
      <block type="orbit"></block>
      <block type="follow"></block>
    </category>-->
    <category name="Land">
      <block type="land"></block>
      <block type="land_home"></block>
    </category>
  </xml>

  <script>
    var blocklyArea = document.getElementById('blocklyArea');
    var blocklyDiv = document.getElementById('blocklyDiv');
    var workspace = Blockly.inject(blocklyDiv,
        {media: 'blockly/media/',
         toolbox: document.getElementById('toolbox')});
    var onresize = function(e) {
      // Compute the absolute coordinates and dimensions of blocklyArea.
      var element = blocklyArea;
      var x = 0;
      var y = 0;
      do {
        x += element.offsetLeft;
        y += element.offsetTop;
        element = element.offsetParent;
      } while (element);
      // Position blocklyDiv over blocklyArea.
      blocklyDiv.style.left = x + 'px';
      blocklyDiv.style.top = y + 'px';
      blocklyDiv.style.width = blocklyArea.offsetWidth + 'px';
      blocklyDiv.style.height = blocklyArea.offsetHeight + 'px';
    };
    window.addEventListener('resize', onresize, false);
    onresize();
    
    function getMobileOS() {
      var userAgent = navigator.userAgent || navigator.vendor || window.opera;
      if( userAgent.match( /iPad/i ) || userAgent.match( /iPhone/i ) || userAgent.match( /iPod/i ) ) {
        return 'iOS';
      }
      else if( userAgent.match( /Android/i ) ) {
        return 'Android';
      }
      else {
        return 'unknown';
      }
    }
    
    function uploadMission() {
      var os = getMobileOS();
      if(os == 'iOS') {
        document.location.href='ios:' + Blockly.JavaScript.workspaceToCode(workspace);
      } else if(os == 'Android') {
      	Android.parseMission(Blockly.JavaScript.workspaceToCode(workspace));
      }
    }
    
    var blockIndex = 0;
    
    function highlightBlock(id) {
      var id = parseInt(id); // This is the index of the waypoint block we're highlighting
      var blocks = Blockly.mainWorkspace.getAllBlocks();
      
      // Now let's loop until we find the next waypoint
      for(var i=blockIndex; i<=blocks.length; i++) {
        var type = blocks[i].type;
        
        blockIndex++;
        
        if(type == "takeoff" || type == "fly_forward" || type == "change_altitude" || type == "land") {
          blocks[i].select();
          
          if(type == "land") {
            blockIndex = 0; // Reset the block index
          }
          
          break;
        }
      }
    }
    
    function highlightBlockFromAndroid(id) {
      var id = parseInt(id);
      var blocks = Blockly.mainWorkspace.getAllBlocks();
      blocks[id].select();
    }
    
    // Listen for workspace changes and save blocks
    function saveBlocks() {
      BlocklyStorage.backupBlocks_(Blockly.getMainWorkspace());
    }
    workspace.addChangeListener(saveBlocks);
    
    // Load last set of blocks
    window.setTimeout(BlocklyStorage.restoreBlocks, 1000);
  </script>
</body>
</html>
